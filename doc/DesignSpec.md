## Screenshot Plugin 设计规范文档

### 一、项目概述

* **插件名称**：ScreenshotPlugin
* **目标**：**一键截取当前标签页可视区域**，并方便下载或保存历史记录。
* **适用场景**：快速获取网页截图，用于笔记、分享、协作。
* **非功能性需求**：

  * **性能要求**：截图生成时间应小于 2 秒，历史记录页加载缩略图时间不超过 1 秒。
  * **兼容性要求**：兼容主流 Chromium 内核浏览器（Chrome、Edge），支持最低版本 Chrome 89 及以上。
  * **安全性要求**：仅在用户触发时调用截图权限，所有数据均存储在本地，不上传至服务器。

---

### 二、需求与用户故事

1. **用户故事一：快速截屏并下载**

   * **描述**：作为用户，我希望点击工具栏按钮后立即截取当前可视区域并自动下载截图。
   * **验收标准**：点击按钮后 ≤ 2 秒内成功下载截图文件，文件名自动带时间戳。

2. **用户故事二：管理历史截图**

   * **描述**：作为用户，我希望能在选项页查看并管理历史截图。
   * **验收标准**：打开选项页后可见截图缩略图列表，每项可删除并即时更新界面。

3. **用户故事三：切换截屏模式**

   * **描述**：作为用户，我希望可以选择截取整个页面还是仅可视区域。
   * **验收标准**：在弹出页或设置页中可见截屏模式切换，选择后实际截取内容与设置一致。

**功能需求**：

* 可视区域截图
* 全页截图（可选，通过滚动拼接）
* 本地下载（PNG 格式）
* 历史记录管理（在选项页展示缩略图及删除功能）
* 基本标注（矩形框、文字）

---

### 三、功能模块划分

| 模块             | 责任                                                    |
| -------------- | ----------------------------------------------------- |
| Manifest       | 插件元信息、权限声明、页面入口                                       |
| 权限管理           | 集中声明并审核插件权限（tabs、activeTab、downloads 等），确保按需授权，减少安全隐患 |
| Background     | 截图核心逻辑、消息监听、存储管理                                      |
| Popup          | 弹出界面：按钮触发截图及模式切换                                      |
| Options        | 选项页：历史记录管理、配置面板                                       |
| Content Script | （可选）全页截图滚动拼接、区域选择功能                                   |
| Storage        | 使用 `chrome.storage.local` 保存截图数据和元信息                  |
| UI/Canvas      | 标注功能：基于 Canvas API 绘制标注                               |

---

### 四、信息流与交互流程

1. 用户点击工具栏按钮 → 弹出页打开 → 点击“截取”按钮
2. 弹出页发送 `chrome.runtime.sendMessage({action: 'capture', mode})` 至后台
3. 后台调用 `chrome.tabs.captureVisibleTab` 或通过内容脚本拼接全页截图
4. 后台保存 DataURL 至 Storage，并将 URL 返回给弹出页
5. 弹出页处理下载或显示预览，并更新状态提示
6. 选项页加载时，从 Storage 读取历史记录并渲染缩略图列表

**错误处理与重试机制**：

* 截图失败：提示“截图失败，请重试”，显示重试按钮。
* 存储失败：提示“存储失败，请清理历史记录或稍后再试”。
* 下载失败：回退为弹出预览，允许用户右键另存为。
* 所有异常记录于 `chrome.runtime.lastError`，并可在选项页查看日志。

---

### 五、界面设计（Wireframe）

* **Popup**：

  * 标题
  * 截屏模式切换下拉或切换按钮
  * “截取”按钮
  * 状态提示栏（加载中、成功、失败）

* **Options**：

  * 历史截图网格列表（缩略图 + 时间戳 + 删除按钮）
  * 配置区域：自动保存开关、全页截取开关
  * 日志查看按钮

> **示例草图**：可参考 Figma 项目（链接占位），或上传手绘草图以对齐 UI 预期。

---

### 六、技术选型

* **核心 API**：Chrome Tabs API、Chrome Storage API、Canvas API
* **开发语言**：TypeScript + Vanilla JS（轻量，无需 React）
* **构建工具**：Vite（开发热重载、生产打包）
* **测试框架**：Vitest + Playwright（单元测试与端到端测试）
* **代码规范**：ESLint + Prettier

> 如后续 UI 需求复杂，可考虑引入轻量级框架（如 Preact）或组件库（如 Shoelace、Material Web Components）。

---

### 七、后续扩展

* 多种标注工具（箭头、涂鸦、文本高亮）
* 第三方同步（OneDrive、Google Drive）
* 插件国际化（i18n）
* 自动化测试覆盖（截图流程、UI 操作）
* 持续集成 & 部署：GitHub Actions — 构建、测试、打包，发布至商店
* **可视化分析**：集成简单的使用频率统计和错误日志上报（匿名数据）以优化功能
* **可访问性**：遵循 WCAG 指南，为弹出页与选项页提供可键盘导航、ARIA 标签支持

---

### 八、质量保障与维护

1. **版本管理**：采用语义化版本号（SemVer），在每次发布前更新 CHANGELOG。
2. **错误监控**：集成 Sentry 或自建日志收集，通过 `chrome.runtime.lastError` 捕获并报告关键异常。
3. **性能监测**：在背景页引入简单的性能指标上报（截图时延、拼接耗时），定期评估插件体积与启动时间。
4. **文档与示例**：维护 README 和用户指南，提供常见问题与排错步骤；在项目 Wiki 中保留 API 使用示例。
5. **安全审计**：定期检查 Manifest 与权限声明，最小化权限；对依赖进行漏洞扫描（如使用 `npm audit`）。
6. **回归测试**：每个版本发布前，执行关键功能的端到端测试，确保主流浏览器兼容性。

---

### 九、最佳实践与微调

* **多平台兼容**：使用 `webextension-polyfill` 统一 Chrome、Firefox、Edge API，确保在各浏览器间代码一致。
* **国际化流程**：采用 i18next 进行文本管理，资源文件放置于 `locales/` 目录，插件内支持动态语言切换。
* **插件体积优化**：定期运行 Bundle Analyzer 检查依赖体积；对大模块（如 Canvas 编辑器）使用动态导入（`import()`）。
* **用户反馈与更新**：在选项页提供“反馈”链接，将反馈提交至 GitHub Issues；使用 `chrome.runtime.onUpdateAvailable` 提示新版本并自动更新。
* **数据持久化策略**：为历史截图提供“导出备份”功能，并在本地定期清理旧数据；所有统计与日志数据仅在用户授权下采集。
* **自动化发布**：借助 GitHub Actions 与 `web-ext`，实现自动打包并发布至 Chrome Web Store 和 Firefox Add-ons。
